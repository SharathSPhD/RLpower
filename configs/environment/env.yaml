# Gymnasium environment configuration
# Read by: SCO2FMUEnv, ObservationBuilder, ActionScaler, RateLimiter, VecNormalizeWrapper

# ─── Observation Space ───────────────────────────────────────────────────────
observation:
  history_steps: 5                     # Ring buffer depth
  obs_dim: 100                         # 20 vars × 5 steps

  variables:
    # Temperatures (°C)
    - name: T_turbine_inlet
      fmu_var: "turbine.port_a.T"
      index: 0
      min: 600.0
      max: 850.0
      unit: degC
      description: "Turbine inlet temperature — material limit ≥ 715°C"

    - name: T_compressor_inlet
      fmu_var: "main_compressor.port_a.T"
      index: 1
      min: 30.0
      max: 45.0
      unit: degC
      description: "Main compressor inlet — must stay ≥ 32.2°C (RULE-P1)"

    - name: T_recuperator_ht_hot_out
      fmu_var: "recuperator_high_temp.port_b_out.T"
      index: 2
      min: 100.0
      max: 550.0
      unit: degC

    - name: T_recuperator_lt_hot_out
      fmu_var: "recuperator_low_temp.port_b_out.T"
      index: 3
      min: 40.0
      max: 250.0
      unit: degC

    - name: T_precooler_out
      fmu_var: "precooler.port_b_out.T"
      index: 4
      min: 28.0
      max: 50.0
      unit: degC

    # Pressures (MPa)
    - name: P_high
      fmu_var: "turbine.port_a.p"
      index: 5
      min: 14.0
      max: 26.0
      unit: MPa
      description: "High-side pressure — must stay ≤ 22 MPa"

    - name: P_low
      fmu_var: "main_compressor.port_a.p"
      index: 6
      min: 6.5
      max: 9.5
      unit: MPa
      description: "Low-side pressure — CO₂ critical pressure = 7.38 MPa"

    # Mass flows (kg/s)
    - name: mdot_turbine
      fmu_var: "turbine.port_a.m_flow"
      index: 7
      min: 40.0
      max: 220.0
      unit: kg_per_s

    - name: mdot_main_compressor
      fmu_var: "main_compressor.port_a.m_flow"
      index: 8
      min: 25.0
      max: 160.0
      unit: kg_per_s

    - name: mdot_recompressor
      fmu_var: "recompressor.port_a.m_flow"
      index: 9
      min: 5.0
      max: 90.0
      unit: kg_per_s

    # Power outputs (MW)
    - name: W_turbine
      fmu_var: "turbine.W"
      index: 10
      min: 0.0
      max: 25.0
      unit: MW

    - name: W_main_compressor
      fmu_var: "main_compressor.W"
      index: 11
      min: 0.0
      max: 15.0
      unit: MW

    - name: W_recompressor
      fmu_var: "recompressor.W"
      index: 12
      min: 0.0
      max: 10.0
      unit: MW

    - name: W_net
      fmu_var: "W_net"
      index: 13
      min: 0.0
      max: 15.0
      unit: MW
      description: "Net electrical output = W_turbine - W_main_comp - W_recomp"

    # Efficiency and dimensionless quantities
    - name: eta_thermal
      fmu_var: "eta_thermal"
      index: 14
      min: 0.0
      max: 0.60
      unit: dimensionless

    - name: surge_margin_main
      fmu_var: "main_compressor.surge_margin"
      index: 15
      min: 0.0
      max: 0.60
      unit: dimensionless
      description: "Must stay > 0.05 (RULE-P4)"

    - name: surge_margin_recomp
      fmu_var: "recompressor.surge_margin"
      index: 16
      min: 0.0
      max: 0.60
      unit: dimensionless
      description: "Must stay > 0.05 (RULE-P4)"

    # Disturbance inputs (observed but not controlled)
    - name: T_exhaust_source
      fmu_var: "heat_source.T_exhaust"
      index: 17
      min: 150.0
      max: 1300.0
      unit: degC
      description: "EAF/BOF exhaust temperature — primary disturbance"

    - name: mdot_exhaust_source
      fmu_var: "heat_source.mdot_exhaust"
      index: 18
      min: 5.0
      max: 120.0
      unit: kg_per_s

    # Setpoint (tracking target)
    - name: W_net_setpoint
      fmu_var: null                    # Injected by env, not from FMU
      index: 19
      min: 0.0
      max: 15.0
      unit: MW
      description: "Power demand setpoint — agent must track this"

# ─── Action Space ─────────────────────────────────────────────────────────────
action:
  action_dim: 5
  # Actions are network outputs in [-1, 1], scaled to physical range by ActionScaler
  # RateLimiter enforces max change per communication step (RULE: always applied)

  variables:
    - name: bypass_valve_opening
      fmu_var: "bypass_valve.opening"
      index: 0
      physical_min: 0.0
      physical_max: 1.0
      rate_limit_per_step: 0.05       # Max 5% opening change per 5s step
      description: "Turbine bypass valve — fast load rejection"

    - name: igv_angle_normalized
      fmu_var: "igv.angle_normalized"
      index: 1
      physical_min: 0.0
      physical_max: 1.0
      rate_limit_per_step: 0.05
      description: "Inlet guide vane angle — affects compressor characteristic"

    - name: inventory_valve_opening
      fmu_var: "inventory_valve.opening"
      index: 2
      physical_min: 0.0
      physical_max: 1.0
      rate_limit_per_step: 0.02       # Slower: inventory control is slow-acting
      description: "Inventory control valve — pressure management"

    - name: cooling_flow_normalized
      fmu_var: "cooling_valve.opening"
      index: 3
      physical_min: 0.0
      physical_max: 1.0
      rate_limit_per_step: 0.05
      description: "Cooling water flow — compressor inlet temp control"

    - name: split_ratio
      fmu_var: "split_valve.split_ratio"
      index: 4
      physical_min: 0.15             # min recompression fraction
      physical_max: 0.55             # max recompression fraction
      rate_limit_per_step: 0.03
      description: "Mass flow split ratio between main and recompression paths"

# ─── Reward Weights ───────────────────────────────────────────────────────────
# RULE-C6: Any reward term change requires updating this file AND adding a unit test
reward:
  w_tracking: 1.0                    # Load tracking penalty weight
  w_efficiency: 0.3                  # Thermal efficiency bonus weight
  w_smoothness: 0.1                  # Action smoothness penalty weight
  rated_power_mw: 10.0               # Normalization for tracking penalty
  design_efficiency: 0.47            # Normalization for efficiency bonus
  terminal_failure_reward: -100.0    # On solver failure or catastrophic violation

# ─── Normalization ────────────────────────────────────────────────────────────
normalization:
  use_vec_normalize: true
  norm_obs: true
  norm_reward: true
  clip_obs: 10.0                     # Clip normalized observations
  clip_reward: 10.0                  # Clip normalized rewards
  gamma: 0.99                        # Must match training gamma for reward normalization
  update_freq: 1                     # Update stats every episode

# ─── Episode Configuration ────────────────────────────────────────────────────
episode:
  max_steps: 720                     # From fmu_export.yaml; sync these values
  reset_mode: full                   # 'full': re-initialize FMU from scratch each episode
  # Note: 'fmu2SetFMUState' is NOT used for reset (ADR: non-deterministic with CoolProp)
