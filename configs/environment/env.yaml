# Gymnasium environment configuration — simple_recuperated cycle
# Read by: SCO2FMUEnv, ObservationBuilder, ActionScaler, RateLimiter, VecNormalizeWrapper
#
# Unit conventions (post-FMPyAdapter conversion):
#   Temperatures → °C  (FMU returns K; FMPyAdapter applies offset -273.15)
#   Power        → MW  (FMU returns W;  FMPyAdapter applies scale 1e-6)
#   Pressure     → MPa (FMU returns Pa; FMPyAdapter applies scale 1e-6)
#   Efficiency   → dimensionless (no conversion)

# ─── Observation Space ───────────────────────────────────────────────────────
observation:
  history_steps: 5                     # Ring buffer depth
  obs_dim: 80                          # 16 vars × 5 steps (simple_recuperated)

  variables:
    # ── Temperatures (°C after K→°C conversion) ──────────────────────────────
    - name: T_compressor_inlet
      fmu_var: "main_compressor.T_inlet_rt"
      index: 0
      min: 31.0
      max: 43.0
      unit: degC
      description: "Main compressor inlet — must stay ≥ 32.2°C (RULE-P1)"

    - name: T_compressor_outlet
      fmu_var: "main_compressor.T_outlet_rt"
      index: 1
      min: 37.0
      max: 110.0
      unit: degC

    - name: T_turbine_inlet
      fmu_var: "turbine.T_inlet_rt"
      index: 2
      min: 527.0
      max: 930.0
      unit: degC
      description: "Turbine inlet temperature — driven by WHR heat source"

    - name: T_turbine_outlet
      fmu_var: "turbine.T_outlet_rt"
      index: 3
      min: 477.0
      max: 780.0
      unit: degC

    - name: T_recuperator_hot_in
      fmu_var: "recuperator.T_hot_in"
      index: 4
      min: 477.0
      max: 780.0
      unit: degC
      description: "Recuperator hot-side inlet (= turbine outlet)"

    - name: T_recuperator_cold_in
      fmu_var: "recuperator.T_cold_in"
      index: 5
      min: 37.0
      max: 110.0
      unit: degC
      description: "Recuperator cold-side inlet (= compressor outlet)"

    - name: T_precooler_inlet
      fmu_var: "precooler.T_inlet_rt"
      index: 6
      min: 127.0
      max: 430.0
      unit: degC
      description: "Precooler inlet (after recuperator hot side)"

    - name: T_precooler_outlet
      fmu_var: "precooler.T_outlet_rt"
      index: 7
      min: 31.0
      max: 43.0
      unit: degC
      description: "Precooler outlet (= compressor inlet temperature)"

    # ── Power outputs (MW after W→MW conversion) ─────────────────────────────
    - name: W_turbine
      fmu_var: "turbine.W_turbine"
      index: 8
      min: 0.0
      max: 25.0
      unit: MW

    - name: W_main_compressor
      fmu_var: "main_compressor.W_comp"
      index: 9
      min: 0.0
      max: 8.0
      unit: MW

    # ── Efficiency (dimensionless) ────────────────────────────────────────────
    - name: eta_compressor
      fmu_var: "main_compressor.eta"
      index: 10
      min: 0.70
      max: 0.92
      unit: dimensionless

    - name: eta_recuperator
      fmu_var: "recuperator.eta"
      index: 11
      min: 0.70
      max: 0.98
      unit: dimensionless

    # ── Heat transfer (MW after W→MW conversion) ──────────────────────────────
    - name: Q_recuperator
      fmu_var: "recuperator.Q_actual"
      index: 12
      min: 0.0
      max: 100.0
      unit: MW

    # ── Pressure (MPa after Pa→MPa conversion) ───────────────────────────────
    - name: P_high
      fmu_var: "main_compressor.p_outlet"
      index: 13
      min: 14.0
      max: 24.0
      unit: MPa
      description: "High-side pressure — must stay ≤ 22 MPa"

    # ── Derived (computed by env — no FMU variable) ──────────────────────────
    - name: W_net
      fmu_var: null                    # Derived: W_turbine - W_main_compressor
      index: 14
      min: -5.0
      max: 20.0
      unit: MW
      description: "Net electrical output = W_turbine - W_main_compressor"

    # ── Setpoint (injected by env — no FMU variable) ─────────────────────────
    - name: W_net_setpoint
      fmu_var: null                    # Injected by env, not from FMU
      index: 15
      min: 0.0
      max: 12.0
      unit: MW
      description: "Power demand setpoint — agent must track this"

# ─── Action Space ─────────────────────────────────────────────────────────────
action:
  action_dim: 4
  # Actions are network outputs in [-1, 1], scaled to physical range by ActionScaler
  # RateLimiter enforces max change per communication step (RULE: always applied)
  # Physical ranges are in FMU native units (K for temperatures, Pa for pressures)
  # ADR-S2-1: Actions map to SCOPE component parameters via setReal() between steps

  variables:
    - name: bypass_valve
      fmu_var: "regulator.T_init"
      index: 0
      physical_min: 800.0             # K (527°C — low WHR exhaust)
      physical_max: 1200.0            # K (927°C — peak EAF exhaust)
      rate_limit_per_step: 20.0       # K/step — fast EAF transients allowed
      description: "WHR heat source temperature setpoint (bypass_valve proxy)"

    - name: igv
      fmu_var: "regulator.m_flow_init"
      index: 1
      physical_min: 60.0              # kg/s — minimum stable mass flow
      physical_max: 130.0             # kg/s — maximum rated mass flow
      rate_limit_per_step: 5.0        # kg/s per step — IGV authority
      description: "Compressor mass flow setpoint (IGV proxy)"

    - name: inventory_valve
      fmu_var: "turbine.p_out"
      index: 2
      physical_min: 7.0e6             # Pa (7.0 MPa — minimum low-side pressure)
      physical_max: 9.0e6             # Pa (9.0 MPa — maximum low-side pressure)
      rate_limit_per_step: 2.0e5      # Pa/step (0.2 MPa/step — slow inventory)
      description: "Low-side pressure setpoint (inventory valve proxy)"

    - name: cooling_flow
      fmu_var: "precooler.T_output"
      index: 3
      physical_min: 305.65            # K (32.5°C — 1.4°C above CO₂ critical, RULE-P1)
      physical_max: 315.0             # K (42°C — max allowed compressor inlet T)
      rate_limit_per_step: 0.5        # K/step — precooler thermal inertia
      description: "Precooler target outlet temperature (cooling_flow proxy)"

# ─── Reward Weights ───────────────────────────────────────────────────────────
# RULE-C6: Any reward term change requires updating this file AND adding a unit test
reward:
  w_tracking: 1.0                    # Load tracking penalty weight
  w_efficiency: 0.3                  # Thermal efficiency bonus weight
  w_smoothness: 0.1                  # Action smoothness penalty weight
  rated_power_mw: 10.0               # Normalization for tracking penalty
  design_efficiency: 0.40            # Simple recuperated cycle ~40% (vs recompression 47%)
  terminal_failure_reward: -100.0    # On solver failure or catastrophic violation
  w_net_unit_scale: 1.0              # FMPyAdapter.default_scale_offset() already converts W→MW; no additional scaling needed

# ─── Normalization ────────────────────────────────────────────────────────────
normalization:
  use_vec_normalize: true
  norm_obs: true
  norm_reward: true
  clip_obs: 10.0                     # Clip normalized observations
  clip_reward: 10.0                  # Clip normalized rewards
  gamma: 0.99                        # Must match training gamma for reward normalization
  update_freq: 1                     # Update stats every episode

# ─── Episode Configuration ────────────────────────────────────────────────────
episode:
  max_steps: 720                     # From fmu_export.yaml; sync these values
  reset_mode: full                   # 'full': re-initialize FMU from scratch each episode
  # Note: 'fmu2SetFMUState' is NOT used for reset (ADR: non-deterministic with CoolProp)
