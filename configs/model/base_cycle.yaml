# Modelica topology configuration for the sCO₂ WHR cycle
# SCO2CycleBuilder reads this — no hand-authored .mo files (ADR-002)
# RULE-D3: topology.type drives programmatic component selection — change here, not in code

cycle:
  name: SCO2_WHR
  package: SCO2RecuperatedCycle
  libraries:
    - Modelica
    - ThermoPower
    - SCOPE
    - ExternalMedia

# ─── Topology Selection ───────────────────────────────────────────────────────
# RULE-D3: Switch topology by changing type here — no code changes needed
topology:
  type: simple_recuperated             # WHR-optimized: 1 recuperator, 4 actions
  # type: recompression_brayton        # Higher efficiency: 2 recuperators, 5 actions
  #
  # simple_recuperated flow:
  #   Heat Source → Turbine → Recuperator (hot) → Precooler → Compressor → Recuperator (cold) → Heat Source
  #   Actions: bypass_valve, igv, inventory_valve, cooling_flow
  #
  # recompression_brayton flow (future):
  #   Heat Source → Turbine → RecHT → split → RecLT + Recompressor → RecHT → Heat Source
  #   Actions: bypass_valve, igv, inventory_valve, cooling_flow, split_ratio

# ─── Design Point Parameters ─────────────────────────────────────────────────
parameters:
  net_power_mwe: 10.0
  design_turbine_inlet_temp_c: 700.0   # WHR: lower than ideal-cycle (EAF max ~1200°C, heat exchanger pinch)
  design_turbine_inlet_pressure_mpa: 18.0
  design_compressor_inlet_temp_c: 32.5  # 1.4°C above CO₂ critical point
  design_compressor_inlet_pressure_mpa: 7.5
  design_mass_flow_kg_s: 95.0          # Lower than recompression cycle (simpler)
  design_thermal_efficiency: 0.40      # Simple recuperated: ~35–42% (lower than recompression ~47%)
  design_pressure_ratio: 2.4

# ─── CO₂ Fluid ───────────────────────────────────────────────────────────────
fluid:
  medium: "ExternalMedia.Media.CoolPropMedium"
  coolprop_name: "CarbonDioxide"
  coolprop_options: "enable_BICUBIC=1"  # RULE-P3: mandatory near critical point
  critical_temp_c: 31.1
  critical_pressure_mpa: 7.38

# ─── Components (simple_recuperated topology) ─────────────────────────────────
# ComponentFactory creates typed dataclasses from these entries.
# SCO2CycleBuilder.build() selects which components to instantiate based on topology.type.

components:
  # --- Core turbomachinery ---
  main_compressor:
    type: SCOPE.Compressors.CentrifugalCompressor
    topologies: [simple_recuperated, recompression_brayton]
    params:
      eta_design: 0.88
      N_design_rpm: 3600
      beta_ratio_design: 2.4
      inlet_volume_flow_m3_s: 0.70

  turbine:
    type: SCOPE.Turbines.AxialTurbine
    topologies: [simple_recuperated, recompression_brayton]
    params:
      eta_design: 0.92
      N_design_rpm: 3600
      expansion_ratio_design: 2.4

  # --- Heat exchangers ---
  recuperator:
    type: ThermoPower.Gas.HE
    topologies: [simple_recuperated]   # single recuperator in simple cycle
    params:
      UA_design: 750.0                 # kW/K — sized for simple cycle
      effectiveness_design: 0.92
      pressure_drop_hot_kpa: 45.0
      pressure_drop_cold_kpa: 70.0

  recuperator_high_temp:               # recompression cycle only
    type: ThermoPower.Gas.HE
    topologies: [recompression_brayton]
    params:
      UA_design: 850.0
      effectiveness_design: 0.95
      pressure_drop_hot_kpa: 50.0
      pressure_drop_cold_kpa: 80.0

  recuperator_low_temp:                # recompression cycle only
    type: ThermoPower.Gas.HE
    topologies: [recompression_brayton]
    params:
      UA_design: 650.0
      effectiveness_design: 0.93
      pressure_drop_hot_kpa: 40.0
      pressure_drop_cold_kpa: 60.0

  precooler:
    type: ThermoPower.Gas.HE
    topologies: [simple_recuperated, recompression_brayton]
    params:
      UA_design: 380.0
      T_coolant_inlet_c: 25.0
      mdot_coolant_design_kg_s: 70.0

  heat_source:
    type: SCOPE.HeatSources.ExhaustHeatSource
    topologies: [simple_recuperated, recompression_brayton]
    params:
      T_exhaust_min_c: 200.0
      T_exhaust_max_c: 1200.0
      mdot_exhaust_design_kg_s: 40.0

  # --- Actuators (actions) ---
  bypass_valve:
    type: ThermoPower.Water.ValveLin
    topologies: [simple_recuperated, recompression_brayton]
    params:
      Cv_design: 100.0
      opening_min: 0.0
      opening_max: 1.0

  igv:
    type: SCOPE.Actuators.InletGuideVane
    topologies: [simple_recuperated, recompression_brayton]
    params:
      angle_min_deg: -30.0
      angle_max_deg: 15.0
      design_angle_deg: 0.0

  inventory_valve:
    type: ThermoPower.Water.ValveLin
    topologies: [simple_recuperated, recompression_brayton]
    params:
      Cv_design: 40.0
      opening_min: 0.0
      opening_max: 1.0

  cooling_valve:
    type: ThermoPower.Water.ValveLin
    topologies: [simple_recuperated, recompression_brayton]
    params:
      Cv_design: 85.0
      cooling_flow_min_fraction: 0.50
      cooling_flow_max_fraction: 1.50

  # recompression_brayton only
  recompressor:
    type: SCOPE.Compressors.CentrifugalCompressor
    topologies: [recompression_brayton]
    params:
      eta_design: 0.87
      N_design_rpm: 3600
      beta_ratio_design: 3.0
      inlet_volume_flow_m3_s: 0.30

  split_valve:
    type: ThermoPower.Water.SplitValve
    topologies: [recompression_brayton]
    params:
      split_ratio_min: 0.15
      split_ratio_max: 0.55

# ─── Topology Flow Paths (documentation — SCO2CycleBuilder uses addConnection()) ──
flow_paths:
  simple_recuperated:
    - main_compressor.outlet -> recuperator.cold_in
    - recuperator.cold_out -> heat_source.cold_in
    - heat_source.cold_out -> turbine.inlet
    - turbine.outlet -> recuperator.hot_in
    - recuperator.hot_out -> precooler.hot_in
    - precooler.hot_out -> main_compressor.inlet
    - bypass_valve connects: turbine.outlet -> precooler.hot_in  # bypass path

  recompression_brayton:
    - main_compressor.outlet -> recuperator_low_temp.cold_in
    - recuperator_low_temp.cold_out -> split_valve.inlet
    - split_valve.outlet_a -> recuperator_high_temp.cold_in
    - split_valve.outlet_b -> recompressor.inlet
    - recompressor.outlet -> recuperator_high_temp.cold_in   # mixing
    - recuperator_high_temp.cold_out -> heat_source.cold_in
    - heat_source.cold_out -> turbine.inlet
    - turbine.outlet -> recuperator_high_temp.hot_in
    - recuperator_high_temp.hot_out -> recuperator_low_temp.hot_in
    - recuperator_low_temp.hot_out -> precooler.hot_in
    - precooler.hot_out -> main_compressor.inlet
