# Modelica topology configuration for the sCO₂ WHR cycle
# SCO2CycleBuilder reads this — no hand-authored .mo files (ADR-002)
# RULE-D3: topology.type drives programmatic component selection — change here, not in code

cycle:
  name: SCO2_WHR
  package: SCO2RecuperatedCycle
  libraries:
    - Modelica
    - Steps   # SCOPE library (Steps.* namespace)

# ─── Topology Selection ───────────────────────────────────────────────────────
# RULE-D3: Switch topology by changing type here — no code changes needed
topology:
  type: simple_recuperated             # WHR-optimized: 1 recuperator, 4 actions
  # type: recompression_brayton        # Higher efficiency: 2 recuperators, 5 actions
  #
  # simple_recuperated flow:
  #   Heat Source → Turbine → Recuperator (hot) → Precooler → Compressor → Recuperator (cold) → Heat Source
  #   Actions: bypass_valve, igv, inventory_valve, cooling_flow
  #
  # recompression_brayton flow (future):
  #   Heat Source → Turbine → RecHT → split → RecLT + Recompressor → RecHT → Heat Source
  #   Actions: bypass_valve, igv, inventory_valve, cooling_flow, split_ratio

# ─── Design Point Parameters ─────────────────────────────────────────────────
parameters:
  net_power_mwe: 10.0
  design_turbine_inlet_temp_c: 700.0   # WHR: lower than ideal-cycle (EAF max ~1200°C, heat exchanger pinch)
  design_turbine_inlet_pressure_mpa: 18.0
  design_compressor_inlet_temp_c: 32.5  # 1.4°C above CO₂ critical point
  design_compressor_inlet_pressure_mpa: 7.5
  design_mass_flow_kg_s: 95.0          # Lower than recompression cycle (simpler)
  design_thermal_efficiency: 0.40      # Simple recuperated: ~35–42% (lower than recompression ~47%)
  design_pressure_ratio: 2.4

# ─── CO₂ Fluid ───────────────────────────────────────────────────────────────
# SCOPE uses Steps.Utilities.CoolProp (libMyProps.so), not ExternalMedia.
# PBMedia = Steps.Media.SCO2 is inherited by all TwoPorts-derived components.
# RULE-P3: enable_BICUBIC=1 compiled into libMyProps.so.
fluid:
  medium: "Steps.Media.SCO2"            # PBMedia inherited by all TwoPorts components
  coolprop_name: "CO2"
  coolprop_options: "enable_BICUBIC=1"  # RULE-P3: enforced in libMyProps.so
  critical_temp_c: 31.1
  critical_pressure_mpa: 7.38

# ─── Components ────────────────────────────────────────────────────────────────
# ComponentFactory creates typed dataclasses from these entries.
# SCO2CycleBuilder.build() selects which components to instantiate based on topology.type.
# All types are from the SCOPE library (Steps.Components.* namespace).
#
# Port conventions:
#   TwoPorts (Pump, Turbine, FanCooler, Valve, Regulator): inlet / outlet
#   Recuperator: inlet_hot / outlet_hot / inlet_cold / outlet_cold
#   Splitter: inlet / outlet / outlet_split

components:
  # --- Boundary condition (inlet state: turbine inlet T, P, m_flow) ---
  regulator:
    type: Steps.Components.Regulator
    topologies: [simple_recuperated, recompression_brayton]
    params:
      p_init: 18000000.0    # 18 MPa high-side pressure (Pa)
      T_init: 973.15        # 700°C in K (design turbine inlet)
      m_flow_init: 95.0     # kg/s design mass flow

  # --- Core turbomachinery ---
  main_compressor:
    type: Steps.Components.Pump
    topologies: [simple_recuperated, recompression_brayton]
    params:
      p_outlet: 18000000.0  # 18 MPa high-side pressure (Pa)
      eta: 0.88             # isentropic efficiency

  turbine:
    type: Steps.Components.Turbine
    topologies: [simple_recuperated, recompression_brayton]
    params:
      p_out: 7500000.0      # 7.5 MPa low-side pressure (Pa)
      eta: 0.92             # isentropic efficiency

  # --- Heat exchangers ---
  recuperator:
    type: Steps.Components.Recuperator
    topologies: [simple_recuperated]   # single recuperator in simple cycle
    params:
      eta: 0.92             # heat exchange effectiveness

  recuperator_high_temp:               # recompression cycle only
    type: Steps.Components.Recuperator
    topologies: [recompression_brayton]
    params:
      eta: 0.95

  recuperator_low_temp:                # recompression cycle only
    type: Steps.Components.Recuperator
    topologies: [recompression_brayton]
    params:
      eta: 0.93

  precooler:
    type: Steps.Components.FanCooler
    topologies: [simple_recuperated, recompression_brayton]
    params:
      # RULE-P1: T_compressor_inlet >= 32.2°C (1.1°C above CO2 critical point 31.1°C)
      # 32.5°C = 305.65 K — 1.4°C margin above critical
      T_output: 305.65      # K — precooler outlet temperature

  # --- Actuators (RL actions) ---
  # bypass_valve: sends turbine exhaust to precooler, bypassing recuperator hot side
  bypass_valve:
    type: Steps.Components.Valve
    topologies: [simple_recuperated, recompression_brayton]
    params:
      p_outlet: 7500000.0   # 7.5 MPa — low-side pressure

  # inventory_valve: controls mass inventory (low-side pressure setpoint)
  inventory_valve:
    type: Steps.Components.Valve
    topologies: [simple_recuperated, recompression_brayton]
    params:
      p_outlet: 7500000.0   # 7.5 MPa — low-side pressure

  # recompression_brayton only
  recompressor:
    type: Steps.Components.Pump
    topologies: [recompression_brayton]
    params:
      p_outlet: 18000000.0  # 18 MPa high-side pressure
      eta: 0.87

  split_valve:
    type: Steps.Components.Splitter
    topologies: [recompression_brayton]
    params:
      split_ratio: 0.35     # fraction going to recompressor path

# ─── Topology Flow Paths ────────────────────────────────────────────────────────
# Port names must match SCOPE component interfaces exactly:
#   TwoPorts (Pump, Turbine, FanCooler, Valve, Regulator): inlet / outlet
#   Recuperator: inlet_hot / outlet_hot / inlet_cold / outlet_cold
#   Splitter: inlet / outlet / outlet_split
#
# Cycle flow (simple_recuperated):
#   Regulator(outlet) → Turbine → Recuperator(hot) → FanCooler → Compressor →
#   Recuperator(cold) → Regulator(inlet)
#   The Regulator acts as the turbine inlet boundary condition + cycle closure.

flow_paths:
  simple_recuperated:
    - regulator.outlet -> turbine.inlet
    - turbine.outlet -> recuperator.inlet_hot
    - recuperator.outlet_hot -> precooler.inlet
    - precooler.outlet -> main_compressor.inlet
    - main_compressor.outlet -> recuperator.inlet_cold
    - recuperator.outlet_cold -> regulator.inlet

  recompression_brayton:
    - regulator.outlet -> turbine.inlet
    - turbine.outlet -> recuperator_high_temp.inlet_hot
    - recuperator_high_temp.outlet_hot -> recuperator_low_temp.inlet_hot
    - recuperator_low_temp.outlet_hot -> precooler.inlet
    - precooler.outlet -> split_valve.inlet
    - split_valve.outlet -> main_compressor.inlet
    - split_valve.outlet_split -> recompressor.inlet
    - main_compressor.outlet -> recuperator_low_temp.inlet_cold
    - recompressor.outlet -> recuperator_high_temp.inlet_cold
    - recuperator_low_temp.outlet_cold -> recuperator_high_temp.inlet_cold
    - recuperator_high_temp.outlet_cold -> regulator.inlet
